---
title: "E-Cigarettes"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    source_code: embed

---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(shiny)
library(viridis)
library(maps)
library(plotly)
library(readr)
```

```{r}
# rsconnect::deployApp("./shiny_legislation_final.Rmd")
# rmarkdown::render("shiny_legislation_final.Rmd", output_format = "flexdashboard::flex_dashboard") # to get html 
```


```{r data, include = FALSE}
# legislation data
legislation_data = read_csv("./data/legislation_data.csv")

# legislation map data
legislation_n = legislation_data %>% 
  group_by(year, state) %>% 
  summarise(n_legislations = n()) 


state_abb = state.name
names(state_abb) = state.abb

# for each year need all states, just NAs if not there
# first find states missing in each year 
all_states = unname(state_abb)
index = 0
list = vector(mode = "list", 
              length = n_distinct(legislation_n %>% pull(year)))
for (yr in c(2011:2018)){
  index = index + 1
  states_not_na = legislation_n %>% 
    filter(year == yr) %>% 
    pull(state)
  missing_states = all_states[!all_states %in% states_not_na]
  list[[index]] = tibble(
    state = missing_states, 
    year = c(rep(yr, length(missing_states))),  
    n_legislations = 0
  )
}
add_df = bind_rows(list)
legislation_full = bind_rows(legislation_n, add_df)

```

Legislation Map
===================================== 

Column {.sidebar}
-----------------------------------------------------------------------

```{r}
years = unique(legislation_full %>% pull(year))

# selectInput widget
selectInput(
  "year_choice", 
  label = h3("Select year"),
  choices = years, selected = 2018)
```

It is evident that the number of legislations have increased amoung all states from 2011 to 2018. Refer to the "Explore" page to look at the specific legislations that became effective each year. 


Column {.tabset .tabset-fade}
-------------------------------------

### Legislation By Year

```{r}
# plot map
renderPlotly({
  legislation_year = legislation_full %>% 
    filter(year ==input[["year_choice"]])

  legislations =  setNames(legislation_year$n_legislations,
                     legislation_year$state)
  g = list(
    scope = 'usa',
    projection = list(type = "state"),
    showlakes = TRUE,
    lakecolor = toRGB('white')
  )

  plot_geo() %>%
    add_trace(
      z = ~legislations, 
      text = state.name, 
      colors = "Blues", 
      span = I(0),
      locations = state.abb, 
      locationmode = 'USA-states',
      showlegend = FALSE
    ) %>%
    layout(geo = g, 
           title = "Number of Legislations in the US")

})
```


### Description

Through this map, we can view how e-cigarette use among youth was increasingly viewed as dangerous across time. In 2011, only a few states had passed any legislation to restrict access and use of cigarettes among this population. However, by 2018 all but two states in the US had laws controlling e-cigarette use among adolescents. This trend reflects the growing popularity of vaping across teenagers in the United States, as observed in the survey data. As more youth took up e-cigarettes, legislators reacted with policy to attempt to restrict their consumption and access to these products. 

Additionally, through the map we can view the awareness and concern surrounding e-cigarettes across time. In 2011 the trend was just starting, and we see states such as California, Connecticut, and Alaska taking action. This likely reflects the company Juul gaining popularity through media campaigns, particularly in California. From 2013 to 2016 these early action states have relatively less legislative activity surrounding e-cigarettes, as many parts of the US also begin regulating e-cigarette consumption. By 2017 concerns over e-cigarette use among minors has swept the country, and almost all states have some legislation enacted. In 2018, Wyoming and Wisconsin are the only states who have not addressed e-cigarette use by youth.   


Explore
===================================== 

Column {.sidebar}
-----------------------------------------------------------------------

```{r}

# selectInput widget
selectInput(
  "year_table_choice", 
  label = h3("Select year"),
  choices = years, selected = 2011)

provision_choice = legislation_data %>% distinct(measure_desc) %>% pull()

# radioButtons widget
radioButtons(
  "provision_choice", 
  label = h3("Choose provision"),
  choices = provision_choice, selected = "E-Cigarette Sales")

provision_grp_choice = legislation_data %>% distinct(provision_group_desc) %>% pull()

# radioButtons widget
radioButtons(
  "provision_grp_choice", 
  label = h3("Choose provision type"),
  choices = provision_grp_choice, selected = "Restrictions")

```
    
    
Column {.tabset}
-----------------------------------------------------------------------

```{r}
data = legislation_data %>% 
  filter(provision_value != "No Provision") %>% 
  group_by(year, state, measure_desc, provision_group_desc, provision_desc, provision_value) %>% 
  summarize(n = n()) %>% ungroup()


renderTable({
data %>%  
  filter(year == input[["year_table_choice"]], 
         measure_desc == input[["provision_choice"]],
         provision_group_desc == input[["provision_grp_choice"]]) %>% 
  ungroup() %>% 
  filter(provision_desc != "Minimum Age")  %>% 
  distinct(state, provision_desc, provision_value) 
})
```


Prevalence 
===================================== 


```{r, include= FALSE}
state_prev = read_csv("./data/state_prev.csv")

state_prev = 
  state_prev %>% 
  mutate(state = trimws(state), 
         total_prev = as.numeric(total_prev), 
         male_prev = as.numeric(male_prev), 
         female_prev = as.numeric(female_prev)) %>% 
  filter(state != "District of Columbia")
```


Row {.tabset}
-----------------------------------------------------------------------

### E-Cigarette Prevalence in Adults 

```{r }

  Prevalence =  setNames(state_prev$total_prev,
                     state_prev$state)
  p = list(
    scope = 'usa',
    projection = list(type = "state"),
    showlakes = TRUE,
    lakecolor = toRGB('white')
  )

  plot_geo() %>%
    add_trace(
      z = ~Prevalence, 
      text = state.name, 
      colors = "Reds", 
      span = I(0),
      locations = state.abb, 
      locationmode = 'USA-states',
      showlegend = FALSE
    ) %>%
    layout(geo = p, 
           title = "Prevalence of E-Cigs in Adults")

  
```

### Legislations and Prevalence 

```{r}
all_legislations  = legislation_full %>% 
    group_by(state) %>% 
    summarise(total_legislations = sum(n_legislations))

prev_legislation = merge(all_legislations, state_prev, by = "state")

prev_legislation %>% 
  mutate(text_label = str_c(state, ": ", total_legislations, " total legislations")) %>% 
  plot_ly(
        x = ~total_prev, 
        y = ~total_legislations, 
        type = "scatter", 
        mode = "markers", 
        color = ~state, 
        text = ~text_label, alpha = 0.5) %>% 
  layout(title = "Total Legislations by Prevalence of E-Cigarettes",
         xaxis = list(title = "Total Prevalence"),
         yaxis = list(title = "Total Legislations"), 
         showlegend = FALSE, 
         showscale = FALSE)

```


### Description

While state by state data for the prevalence of e-cigarettes among youth is not publicly available, from the map we can view the prevalence of e-cigarettes for adults in 2016. Although it is likely not identical to trends among youth, this data helps visualize consumption across the country and what states might have highest levels of e-cigarette sales. 

South Dakota has the lowest prevalence of e-cigarette use, at 2.9%.  Oklahoma has the highest prevalence, at 6.7%. In general, Appalachia and the Southwest appear to have some of the highest e-cig usage, while the Northeast has lower prevalence. 

From the graph “Legislations and Prevalence” we see that there is a slight positive association between legislation regulating e-cigarettes and prevalence by state. We hypothesize that while legislation restricting e-cigarette access might reduce the prevalence, this legislation is likely driven by a high use of e-cigarettes in the state, generating the observed weak association.   

